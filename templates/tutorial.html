{% extends "base.html" %}

{% block header_title %}{{ tutorial.title }}{% endblock %}

{% block content %}
<!-- Tutorial Header -->
<div class="mobile-section">
    <div class="mobile-card">
        <div class="tutorial-header">
            <h3 class="tutorial-title">{{ tutorial.title }}</h3>
            <div class="tutorial-meta">
                <span class="difficulty-badge difficulty-{{ tutorial.difficulty.lower().replace(' ', '-') }}">
                    {{ tutorial.difficulty }}
                </span>
                <span class="duration-badge">
                    <i class="fas fa-clock"></i> {{ tutorial.duration }}
                </span>
            </div>
        </div>
        
        <p class="tutorial-description">{{ tutorial.description }}</p>
        
        <div class="tutorial-tools">
            {% for tool in tutorial.tools %}
            <span class="tool-tag">{{ tool }}</span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Warning Alert -->
{% if tutorial.warning %}
<div class="mobile-section">
    <div class="mobile-alert">
        <div class="alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="alert-content">
            <div class="alert-title">Legal Warning</div>
            <div class="alert-text">{{ tutorial.warning }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Module Navigation -->
{% if tutorial.modules %}
<div class="mobile-section">
    <div class="module-nav">
        <h4><i class="fas fa-list"></i> Learning Modules</h4>
        <ul class="module-list">
            {% for module in tutorial.modules %}
            <li class="module-item">
                <a href="#module-{{ module.id }}" class="module-link">
                    <i class="fas fa-play-circle"></i>
                    <span>{{ module.title }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<!-- Tutorial Steps -->
<div class="mobile-section">
    {% for step in tutorial.steps %}
    <div class="step-content" {% if tutorial.modules %}id="module-{{ step.module }}"{% endif %}>
        <h3 class="step-title">
            <i class="fas fa-terminal"></i> {{ step.title }}
        </h3>
        
        <p class="step-description">{{ step.content }}</p>
        
        <!-- Code Block -->
        {% if step.code %}
        <div class="code-container">
            <div class="code-header">
                <span class="code-language">bash</span>
                <button class="copy-btn" onclick="copyCode(this)">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="code-content">
                <pre><code class="language-bash">{{ step.code }}</code></pre>
            </div>
        </div>
        {% endif %}
        
        <!-- Explanation -->
        {% if step.explanation %}
        <div class="step-explanation">
            <strong><i class="fas fa-lightbulb"></i> Understanding:</strong>
            {{ step.explanation }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- Navigation Footer -->
<div class="mobile-section">
    <div class="mobile-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="{{ url_for('index') }}" style="color: var(--accent-blue); text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Back to Tutorials
            </a>
            <button onclick="toggleBookmark()" style="background: none; border: none; color: var(--accent-orange); font-size: 1.2rem;">
                <i class="fas fa-bookmark"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Copy code functionality
function copyCode(button) {
    const codeContent = button.closest('.code-container').querySelector('.code-content code');
    const text = codeContent.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.style.background = 'var(--accent-green)';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = 'var(--accent-blue)';
        }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.style.background = 'var(--accent-green)';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = 'var(--accent-blue)';
        }, 2000);
    });
}

// Module navigation
document.querySelectorAll('.module-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        
        if (targetElement) {
            // Remove active class from all links
            document.querySelectorAll('.module-link').forEach(l => l.classList.remove('active'));
            // Add active class to clicked link
            this.classList.add('active');
            
            // Smooth scroll to target
            targetElement.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// Bookmark functionality
function toggleBookmark() {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarkedTutorials') || '[]');
    const currentTutorial = '{{ tutorial.id }}';
    
    if (bookmarks.includes(currentTutorial)) {
        const index = bookmarks.indexOf(currentTutorial);
        bookmarks.splice(index, 1);
        showToast('Removed from bookmarks');
    } else {
        bookmarks.push(currentTutorial);
        showToast('Added to bookmarks');
    }
    
    localStorage.setItem('bookmarkedTutorials', JSON.stringify(bookmarks));
}

// Simple toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--tertiary-bg);
        color: var(--text-primary);
        padding: 12px 24px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        z-index: 10000;
        font-size: 0.9rem;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 2000);
}

// Intersection Observer for module navigation
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const moduleId = entry.target.id;
            const correspondingLink = document.querySelector(`a[href="#${moduleId}"]`);
            
            if (correspondingLink) {
                document.querySelectorAll('.module-link').forEach(l => l.classList.remove('active'));
                correspondingLink.classList.add('active');
            }
        }
    });
}, {
    threshold: 0.5,
    rootMargin: '-80px 0px -80px 0px'
});

// Observe all step content elements
document.querySelectorAll('.step-content[id]').forEach(el => {
    observer.observe(el);
});

// Search functionality from header
function toggleSearch() {
    window.location.href = '{{ url_for("search") }}';
}

function toggleBookmarks() {
    const bookmarks = JSON.parse(localStorage.getItem('bookmarkedTutorials') || '[]');
    if (bookmarks.length === 0) {
        showToast('No bookmarks yet');
    } else {
        showToast(`${bookmarks.length} bookmarked tutorials`);
    }
}

function showSettings() {
    showToast('Settings coming soon');
}
</script>
{% endblock %}